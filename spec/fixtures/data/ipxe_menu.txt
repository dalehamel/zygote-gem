#!ipxe

# This template is shamelessly ripped off from https://gist.github.com/robinsmidsrod/2234639
# The most notable change is that we are of course dynamically generating the menu using cells.


# Some menu defaults
set menu-timeout 10
set submenu-timeout ${menu-timeout}

# Allow overriding the menu default for automation


isset ${menu-default} || set menu-default exit

# Figure out if client is 64-bit capable
cpuid --ext 29 && set arch x64 || set arch x86
cpuid --ext 29 && set archl amd64 || set archl i386

###################### MAIN MENU ####################################


# This menu should be dynamically generated from cells, probably just make a metadata format

:start
menu iPXE boot menu for SPM-ZM143S050147 from unknown
item --gap --             ------------------------- OS Installation --------------------------------
  
item --key u submenu-ubuntu Select preseeds for ubuntu installer...
item --gap --             ------------------------- Tools and utilities ----------------------------
  
item --key a alchemy Boot Alchemy Linux
  
item --key m memtest Run Memtest86
item --gap --             ------------------------- Advanced opts -------------------------------
item --key c config       Configure settings
item shell                Drop to iPXE shell
item reboot               Reboot computer
item
item --key x exit         Exit iPXE and continue BIOS boot
choose --timeout ${menu-timeout} --default ${menu-default} selected || goto cancel
set menu-timeout 0
goto ${selected}

# Generated menu entries for each cell
:alchemy
chain --replace --autofree  http://${dhcp-server}/cell/alchemy/boot?dhcp-server=172.16.2.4?&mac=0c:c4:7a:05:77:1a&serial=S15500224715585&product=SYS-2027PR-HTTR&manufacturer=Supermicro&board-serial=ZM143S050147&board-product=X9DRT-PT&ip=unknown&sku=SPM-ZM143S050147
:memtest86
chain --replace --autofree  http://${dhcp-server}/cell/memtest/boot?dhcp-server=172.16.2.4?&mac=0c:c4:7a:05:77:1a&serial=S15500224715585&product=SYS-2027PR-HTTR&manufacturer=Supermicro&board-serial=ZM143S050147&board-product=X9DRT-PT&ip=unknown&sku=SPM-ZM143S050147

# Render any submenus

# Create the main submenu entry to render the submenu
:submenu-ubuntu
menu Select preseeds for ubuntu installer...

# Add each entry to the submenu
  
item  ubuntu-automatic Automatic, default(raid1)
  
item  ubuntu-automatic-raid5 Automatic, raid5 (6 disks)
  
item  ubuntu-automatic-single-sda Automatic, single disk - sda
  
item  ubuntu-automatic-single-sdb Automatic, single disk - sdb
  
item  ubuntu-manual Manual install
  

# Toss in the boilerplate footer
item
item --key 0x08 back      Back to top menu...
choose --timeout ${submenu-timeout} --default ${submenu-default} selected || goto start
set submenu-timeout 0
goto ${selected}

# Now generate the boot entries for each submenu label
  
    
    
:ubuntu-automatic
chain --replace --autofree  http://${dhcp-server}/cell/ubuntu/boot?entry=automatic&raid=raid1&dhcp-server=172.16.2.4?&mac=0c:c4:7a:05:77:1a&serial=S15500224715585&product=SYS-2027PR-HTTR&manufacturer=Supermicro&board-serial=ZM143S050147&board-product=X9DRT-PT&ip=unknown&sku=SPM-ZM143S050147
  
    
    
:ubuntu-automatic-raid5
chain --replace --autofree  http://${dhcp-server}/cell/ubuntu/boot?entry=automatic-raid5&raid=raid5&dhcp-server=172.16.2.4?&mac=0c:c4:7a:05:77:1a&serial=S15500224715585&product=SYS-2027PR-HTTR&manufacturer=Supermicro&board-serial=ZM143S050147&board-product=X9DRT-PT&ip=unknown&sku=SPM-ZM143S050147
  
    
    
:ubuntu-automatic-single-sda
chain --replace --autofree  http://${dhcp-server}/cell/ubuntu/boot?entry=automatic-single-sda&raid=single&root_disk=sda&dhcp-server=172.16.2.4?&mac=0c:c4:7a:05:77:1a&serial=S15500224715585&product=SYS-2027PR-HTTR&manufacturer=Supermicro&board-serial=ZM143S050147&board-product=X9DRT-PT&ip=unknown&sku=SPM-ZM143S050147
  
    
    
:ubuntu-automatic-single-sdb
chain --replace --autofree  http://${dhcp-server}/cell/ubuntu/boot?entry=automatic-single-sdb&raid=single&root_disk=sdb&dhcp-server=172.16.2.4?&mac=0c:c4:7a:05:77:1a&serial=S15500224715585&product=SYS-2027PR-HTTR&manufacturer=Supermicro&board-serial=ZM143S050147&board-product=X9DRT-PT&ip=unknown&sku=SPM-ZM143S050147
  
    
    
:ubuntu-manual
chain --replace --autofree  http://${dhcp-server}/cell/ubuntu/boot?entry=manual&manual=true&dhcp-server=172.16.2.4?&mac=0c:c4:7a:05:77:1a&serial=S15500224715585&product=SYS-2027PR-HTTR&manufacturer=Supermicro&board-serial=ZM143S050147&board-product=X9DRT-PT&ip=unknown&sku=SPM-ZM143S050147
  

##########################################

:cancel
echo You cancelled the menu, dropping you to a shell

:shell
echo Type 'exit' to get the back to the menu
shell
set menu-timeout 0
set submenu-timeout 0
goto start

:failed
echo Booting failed, dropping to shell
goto shell

:reboot
reboot

:exit
# On dell servers exit causes a PXE boot loop.
# This tells the server to boot from first drive instead
# http://ipxe.org/cmd/sanboot
# http://ipxe.org/appnote/work_around_bios_halting_on_ipxe_exit

sanboot --no-describe --drive 0x80
#exit

:config
config
goto start

:back
set submenu-timeout 0
clear submenu-default
goto start

