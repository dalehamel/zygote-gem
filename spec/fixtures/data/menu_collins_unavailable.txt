#!ipxe

# This template is shamelessly ripped off from https://gist.github.com/robinsmidsrod/2234639
# The most notable change is that we are of course dynamically generating the menu using spells.

# Some menu defaults

set menu-timeout 10000
set submenu-timeout ${menu-timeout}

# Allow overriding the menu default for automation
set menu-default  exit


isset ${menu-default} || set menu-default exit

# Figure out if client is 64-bit capable
cpuid --ext 29 && set arch x64 || set arch x86
cpuid --ext 29 && set archl amd64 || set archl i386

###################### MAIN MENU ####################################


# This menu should be dynamically generated from spells, probably just make a metadata format

:start
menu iPXE boot menu for UKN-some-serial from 
item --gap --             ------------------------- OS Installation --------------------------------
item --key o menu-coreos Select CoreOS channel to boot...
item --key u menu-ubuntu Select preseeds for ubuntu installer...
item --gap --             ------------------------- Tools and utilities ----------------------------
item --key a alchemy Boot Alchemy Linux
item --key b burnin Burnin - Perform server torture
item --key d dset Dell Dset
item --key f menu-firmware Select firmware upgrade..
item --key m memtest86 Run Memtest86
item --gap --             ------------------------- Advanced opts -------------------------------
item --key c config       Configure settings
item shell                Drop to iPXE shell
item reboot               Reboot computer
item
item --key x exit         Exit iPXE and continue BIOS boot
choose --timeout ${menu-timeout} --default ${menu-default} selected || goto cancel
set menu-timeout 0
goto ${selected}

:alchemy
set base-url  http://${dhcp-server}
chain --replace --autofree  http://${dhcp-server}/spell/render/alchemy/boot?sku=UKN-some-serial
:burnin
chain --replace --autofree  http://${dhcp-server}/spell/render/burnin/boot?sku=UKN-some-serial
:menu-coreos
menu CoreOS Channels
    item  upstream_364 Boot Upstream build 364
    item  coreos_alpha Boot Internal Alpha Channel
    item  coreos_beta Boot Internal Beta Channel
    item  coreos_test Boot Internal Test Channel
item
item --key 0x08 back      Back to top menu...
iseq ${menu-default} menu-coreos && isset ${submenu-default} && goto menu-coreos-timed ||
choose selected && goto ${selected} || goto start


:upstream_364
chain --replace --autofree  http://${dhcp-server}/spell/render/coreos/boot?sku=UKN-some-serial&build=upstream_364

:coreos_alpha
chain --replace --autofree  http://${dhcp-server}/spell/render/coreos/boot?sku=UKN-some-serial&build=coreos_alpha

:coreos_beta
chain --replace --autofree  http://${dhcp-server}/spell/render/coreos/boot?sku=UKN-some-serial&build=coreos_beta

:coreos_test
chain --replace --autofree  http://${dhcp-server}/spell/render/coreos/boot?sku=UKN-some-serial&build=coreos_test
:dset
echo Starting Dell Dset ${initiator-iqn}
set base-url  http://${dhcp-server}
sanboot ${base-url}/firmware/OMSA70-CentOS6-x86_64-LiveDVD.iso || goto failed
:menu-firmware
menu firmware upgrade options for ${initiator-iqn}
item corsair-m500-mu05 Corsair M500 MU05 upgrade
item dell              Dell Firmware
item
item --key 0x08 back      Back to top menu...
iseq ${menu-default} menu-firmware && isset ${submenu-default} && goto menu-firmware-timed ||
choose selected && goto ${selected} || goto start

:corsair-m500-mu05
chain --replace --autofree  http://${dhcp-server}/spell/render/firmware/boot?sku=UKN-some-serial&firmware=corsair_m500

:dell
chain --replace --autofree  http://${dhcp-server}/spell/render/firmware/boot?sku=UKN-some-serial&firmware=dell
:memtest86
chain --replace --autofree  http://${dhcp-server}/spell/render/memtest/boot?sku=UKN-some-serial
:menu-ubuntu
menu Ubuntu preseeds for ${initiator-iqn}
    item  ubuntu-trusty-install Install Ubuntu Trusty 14.04 Automatic - RAID1
    item  ubuntu-trusty-install-btrfs Install Ubuntu Trusty 14.04 Automatic - btrfs
    item  ubuntu-trusty-install-raid5 Install Ubuntu Trusty 14.04 Automatic - RAID5
    item  ubuntu-trusty-install-hwraid Install Ubuntu Trusty 14.04 Automatic - hwraid
    item  ubuntu-trusty-install-select-swap Install Ubuntu Trusty 14.04 Select Swap
    item  ubuntu-trusty-install-select-network Install Ubuntu Trusty 14.04 Select Network Interface
    item  ubuntu-trusty-install-select-swap-network Install Ubuntu Trusty 14.04 Select Swap and Network Interface
    item  ubuntu-trusty-install-manual Install Ubuntu Trusty 14.04 Manual Install
    item  ubuntu-precise-install Install Ubuntu Precise 12.04 Automatic - RAID1
    item  ubuntu-precise-install-btrfs Install Ubuntu Precise 12.04 Automatic - btrfs
    item  ubuntu-precise-install-raid5 Install Ubuntu Precise 12.04 Automatic - RAID5
    item  ubuntu-precise-install-hwraid Install Ubuntu Precise 12.04 Automatic - hwraid
    item  ubuntu-precise-install-select-swap Install Ubuntu Precise 12.04 Select Swap
    item  ubuntu-precise-install-select-network Install Ubuntu Precise 12.04 Select Network Interface
    item  ubuntu-precise-install-select-swap-network Install Ubuntu Precise 12.04 Select Swap and Network Interface
    item  ubuntu-precise-install-manual Install Ubuntu Precise 12.04 Manual Install
item
item --key 0x08 back      Back to top menu...
choose --timeout ${submenu-timeout} --default ${submenu-default} selected || goto start
set submenu-timeout 0
goto ${selected}


:ubuntu-trusty-install
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=trusty&mac=${mac}&raid=raid1

:ubuntu-trusty-install-btrfs
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=trusty&mac=${mac}&storagefs=btrfs&raid=raid1

:ubuntu-trusty-install-raid5
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=trusty&mac=${mac}&raid=raid5

:ubuntu-trusty-install-hwraid
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=trusty&mac=${mac}&raid=hwraid

:ubuntu-trusty-install-select-swap
echo -n Enter a swap value (in MB): && read swapsize
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=trusty&mac=${mac}&swapsize=${swapsize}

:ubuntu-trusty-install-select-network
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=trusty&mac=${mac}&netinterface=manual

:ubuntu-trusty-install-select-swap
echo -n Enter a swap value (in MB): && read swapsize
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=trusty&mac=${mac}&swapsize=${swapsize}&netinterface=manual

:ubuntu-trusty-install-manual
echo Starting Ubuntu trusty ${archl} manual install for ${initiator-iqn}
set base-url http://${dhcp-server}/ubuntu/trusty
kernel ${base-url}/install/netboot/ubuntu-installer/${archl}/linux
initrd ${base-url}/install/netboot/ubuntu-installer/${archl}/initrd.gz
imgargs linux \
  tasks=standard  \
  debian-installer/locale=en_US.utf8 \
  console-setup/ask_detect=false \
  keyboard-configuration/layoutcode=us \
  live-installer/net-image=${base-url}/install/filesystem.squashfs \
  netcfg/dhcp_timeout=120 \
  net.ifnames=1 biosdevname=0 \
  console=tty0 console=ttyS1,115200n8
boot || goto failed
goto start


:ubuntu-precise-install
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=precise&mac=${mac}&raid=raid1

:ubuntu-precise-install-btrfs
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=precise&mac=${mac}&storagefs=btrfs&raid=raid1

:ubuntu-precise-install-raid5
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=precise&mac=${mac}&raid=raid5

:ubuntu-precise-install-hwraid
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=precise&mac=${mac}&raid=hwraid

:ubuntu-precise-install-select-swap
echo -n Enter a swap value (in MB): && read swapsize
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=precise&mac=${mac}&swapsize=${swapsize}

:ubuntu-precise-install-select-network
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=precise&mac=${mac}&netinterface=manual

:ubuntu-precise-install-select-swap
echo -n Enter a swap value (in MB): && read swapsize
chain --replace --autofree  http://${dhcp-server}/spell/render/ubuntu/boot?sku=UKN-some-serial&iso=precise&mac=${mac}&swapsize=${swapsize}&netinterface=manual

:ubuntu-precise-install-manual
echo Starting Ubuntu precise ${archl} manual install for ${initiator-iqn}
set base-url http://${dhcp-server}/ubuntu/precise
kernel ${base-url}/install/netboot/ubuntu-installer/${archl}/linux
initrd ${base-url}/install/netboot/ubuntu-installer/${archl}/initrd.gz
imgargs linux \
  tasks=standard  \
  debian-installer/locale=en_US.utf8 \
  console-setup/ask_detect=false \
  keyboard-configuration/layoutcode=us \
  live-installer/net-image=${base-url}/install/filesystem.squashfs \
  netcfg/dhcp_timeout=120 \
  net.ifnames=1 biosdevname=0 \
  console=tty0 console=ttyS1,115200n8
boot || goto failed
goto start


:cancel
echo You cancelled the menu, dropping you to a shell

:shell
echo Type 'exit' to get the back to the menu
shell
set menu-timeout 0
set submenu-timeout 0
goto start

:failed
echo Booting failed, dropping to shell
goto shell

:reboot
reboot

:exit
# On dell servers exit causes a PXE boot loop.
# This tells the server to boot from first drive instead
# http://ipxe.org/cmd/sanboot
# http://ipxe.org/appnote/work_around_bios_halting_on_ipxe_exit

sanboot --no-describe --drive 0x80
#exit

:config
config
goto start

:back
set submenu-timeout 0
clear submenu-default
goto start

